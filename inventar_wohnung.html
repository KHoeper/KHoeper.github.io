<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Inventar – eine Wohnung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.4;
      color: #111827;
      background: #f3f4f6;
    }
    body {
      margin: 0;
      padding: 1.5rem;
      max-width: 1100px;
      margin-inline: auto;
    }
    h1, h2 {
      margin-top: 0;
      color: #111827;
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.5rem;
    }
    h2 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      color: #6b7280;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }
    .card {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 25px rgba(15,23,42,0.06);
      margin-bottom: 1.25rem;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .card-header h2 {
      margin: 0;
    }
    .grid {
      display: grid;
      gap: 0.75rem;
    }
    @media (min-width: 768px) {
      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .grid-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #374151;
      display: block;
      margin-bottom: 0.25rem;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
    }
    .btn {
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      white-space: nowrap;
    }
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-ghost {
      background: transparent;
      color: #6b7280;
    }
    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
    }
    .btn-sm {
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .btn-group {
      display: inline-flex;
      gap: 0.25rem;
      flex-wrap: wrap;
    }
    .inline-controls {
      display: flex;
      gap: 0.25rem;
      align-items: center;
      justify-content: flex-start;
    }
    .inline-controls span {
      min-width: 2.5rem;
      text-align: center;
    }
    .muted {
      color: #9ca3af;
      font-size: 0.8rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    th, td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: middle;
    }
    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #6b7280;
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) td {
      background: #f9fafb;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #eff6ff;
      color: #1d4ed8;
    }
    .badge.warning {
      background: #fef3c7;
      color: #92400e;
    }
    .needed-highlight {
      font-weight: 600;
      color: #b91c1c;
    }
    .pill-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
      background: #f9fafb;
    }
    .pill-checkbox input {
      margin: 0;
    }
    .row-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }
    .chip {
      font-size: 0.75rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      background: #f3f4f6;
      color: #374151;
    }
    .no-data {
      padding: 0.75rem 0.5rem;
      font-size: 0.85rem;
      color: #6b7280;
    }
    .table-container {
      max-height: 420px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>Inventar für eine Wohnung</h1>
    <p class="subtitle">
      Verwalte Bestände nach Kategorie und sieh auf einen Blick, was du beim nächsten Mal mitnehmen oder einkaufen musst.
    </p>
  </header>

  <!-- Formular: Artikel anlegen / bearbeiten -->
  <section class="card" id="item-form-section">
    <div class="card-header">
      <h2 id="form-title">Artikel hinzufügen</h2>
      <span class="muted" id="form-hint">Lege neue Artikel an oder passe bestehende an.</span>
    </div>
    <form id="item-form">
      <div class="grid grid-3">
        <div>
          <label for="name">Artikel</label>
          <input id="name" type="text" required placeholder="z. B. Milch, Shampoo, T-Shirts" />
        </div>
        <div>
          <label for="category">Kategorie</label>
          <select id="category" required>
            <option value="">Bitte wählen …</option>
            <option value="Kosmetik">Kosmetik</option>
            <option value="Kleidung">Kleidung</option>
            <option value="Lebensmittel">Lebensmittel</option>
            <option value="Haushalt">Haushalt</option>
            <option value="Sonstiges">Sonstiges</option>
          </select>
        </div>
        <div>
          <label for="unit">Einheit</label>
          <input id="unit" type="text" placeholder="z. B. Liter, Stück, Packungen" />
        </div>
      </div>

      <div class="grid grid-3" style="margin-top:0.75rem;">
        <div>
          <label for="targetQty">Soll-Bestand</label>
          <input id="targetQty" type="number" step="0.01" min="0" value="0" />
        </div>
        <div>
          <label for="currentQty">Ist-Bestand</label>
          <input id="currentQty" type="number" step="0.01" min="0" value="0" />
        </div>
        <div style="display:flex;align-items:flex-end;">
          <span class="muted">„Soll-Bestand“ = Wunschvorrat an diesem Ort.</span>
        </div>
      </div>

      <div class="row-between" style="margin-top:0.9rem;">
        <div class="chips">
          <span class="chip">Beispiel: Milch Soll = 3 Liter, Ist = 1 Liter → 2 mitnehmen/einkaufen.</span>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-secondary btn-sm" id="cancel-edit-btn" style="display:none;">Abbrechen</button>
          <button type="submit" class="btn btn-primary btn-sm" id="submit-btn">Artikel speichern</button>
        </div>
      </div>
    </form>
  </section>

  <!-- Filter / Ansichten -->
  <section class="card">
    <div class="card-header">
      <h2>Ansicht & Filter</h2>
      <span class="muted">Fokussiere auf eine Kategorie oder nur fehlende Bestände.</span>
    </div>
    <div class="grid grid-3">
      <div>
        <label for="filter-category">Kategorie</label>
        <select id="filter-category">
          <option value="">Alle</option>
          <option value="Kosmetik">Kosmetik</option>
          <option value="Kleidung">Kleidung</option>
          <option value="Lebensmittel">Lebensmittel</option>
          <option value="Haushalt">Haushalt</option>
          <option value="Sonstiges">Sonstiges</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;justify-content:flex-start;">
        <label style="visibility:hidden;">Nur benötigte</label>
        <label class="pill-checkbox">
          <input type="checkbox" id="filter-needed-only" />
          nur „mitnehmen / einkaufen“ anzeigen
        </label>
      </div>
    </div>
  </section>

  <!-- Tabelle Inventar -->
  <section class="card">
    <div class="card-header">
      <h2>Inventar</h2>
      <span class="muted">Passe den Ist-Bestand direkt hier an, wenn du etwas verbrauchst.</span>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Artikel</th>
            <th>Kategorie</th>
            <th>Soll</th>
            <th>Ist</th>
            <th>Mitnehmen / Einkaufen</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="items-tbody">
          <!-- Zeilen werden per JavaScript eingefügt -->
        </tbody>
      </table>
      <div id="no-data" class="no-data" style="display:none;">
        Noch keine Artikel angelegt. Lege oben erste Einträge an.
      </div>
    </div>
  </section>

  <!-- Backup / Export -->
  <section class="card">
    <div class="card-header">
      <h2>Backup / Daten kopieren</h2>
      <span class="muted">Optional: Daten als Text sichern oder wiederherstellen.</span>
    </div>
    <div class="row-between" style="margin-bottom:0.5rem;">
      <div class="btn-group">
        <button class="btn btn-secondary btn-sm" id="export-btn">Daten exportieren</button>
        <button class="btn btn-secondary btn-sm" id="import-btn">Daten aus Text übernehmen</button>
        <button class="btn btn-danger btn-sm" id="clear-btn">Alles löschen (Vorsicht)</button>
      </div>
      <span class="muted">Exportierte Daten kannst du in eine Textdatei kopieren.</span>
    </div>
    <textarea id="backup-text" placeholder="Hier erscheinen die Daten beim Export oder du fügst JSON ein, um zu importieren."></textarea>
  </section>

  <script>
    const STORAGE_KEY = "singleFlatInventoryV1";

    let items = [];
    let editId = null;

    function loadItems() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        items = [];
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        items = Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error("Fehler beim Laden aus localStorage:", e);
        items = [];
      }
    }

    function saveItems() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function resetForm() {
      const form = document.getElementById("item-form");
      form.reset();
      document.getElementById("targetQty").value = "0";
      document.getElementById("currentQty").value = "0";
      editId = null;
      document.getElementById("form-title").textContent = "Artikel hinzufügen";
      document.getElementById("form-hint").textContent = "Lege neue Artikel an oder passe bestehende an.";
      document.getElementById("submit-btn").textContent = "Artikel speichern";
      document.getElementById("cancel-edit-btn").style.display = "none";
    }

    function handleFormSubmit(event) {
      event.preventDefault();
      const name = document.getElementById("name").value.trim();
      const category = document.getElementById("category").value;
      const unit = document.getElementById("unit").value.trim();
      const targetQtyVal = document.getElementById("targetQty").value;
      const currentQtyVal = document.getElementById("currentQty").value;

      if (!name || !category) {
        alert("Bitte Artikel und Kategorie ausfüllen.");
        return;
      }

      const targetQty = targetQtyVal === "" ? 0 : parseFloat(targetQtyVal.replace(",", "."));
      const currentQty = currentQtyVal === "" ? 0 : parseFloat(currentQtyVal.replace(",", "."));

      if (isNaN(targetQty) || isNaN(currentQty) || targetQty < 0 || currentQty < 0) {
        alert("Bitte gültige (nicht negative) Zahlen für Soll- und Ist-Bestand eingeben.");
        return;
      }

      if (editId !== null) {
        const idx = items.findIndex(item => item.id === editId);
        if (idx !== -1) {
          items[idx] = {
            ...items[idx],
            name,
            category,
            unit,
            targetQty,
            currentQty
          };
        }
      } else {
        const newItem = {
          id: Date.now(),
          name,
          category,
          unit,
          targetQty,
          currentQty
        };
        items.push(newItem);
      }

      saveItems();
      renderTable();
      resetForm();
    }

    function renderTable() {
      const tbody = document.getElementById("items-tbody");
      const noDataEl = document.getElementById("no-data");
      tbody.innerHTML = "";

      if (!items || items.length === 0) {
        noDataEl.textContent = "Noch keine Artikel angelegt. Lege oben erste Einträge an.";
        noDataEl.style.display = "block";
        return;
      } else {
        noDataEl.style.display = "none";
      }

      const filterCategory = document.getElementById("filter-category").value;
      const neededOnly = document.getElementById("filter-needed-only").checked;

      const sortedItems = [...items].sort((a, b) =>
        (a.name || "").localeCompare(b.name || "", "de", { sensitivity: "base" })
      );

      let visibleCount = 0;

      for (const item of sortedItems) {
        if (filterCategory && item.category !== filterCategory) continue;

        const needed = Math.max((item.targetQty || 0) - (item.currentQty || 0), 0);
        if (neededOnly && needed <= 0) continue;

        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = item.name;
        tr.appendChild(nameTd);

        const catTd = document.createElement("td");
        const catBadge = document.createElement("span");
        catBadge.className = "badge";
        catBadge.textContent = item.category || "–";
        catTd.appendChild(catBadge);
        tr.appendChild(catTd);

        const targetTd = document.createElement("td");
        const targetText = document.createElement("span");
        targetText.textContent = formatNumber(item.targetQty);
        if (item.unit) {
          const unitSpan = document.createElement("span");
          unitSpan.className = "muted";
          unitSpan.style.marginLeft = "0.25rem";
          unitSpan.textContent = item.unit;
          targetTd.appendChild(targetText);
          targetTd.appendChild(unitSpan);
        } else {
          targetTd.textContent = formatNumber(item.targetQty);
        }
        tr.appendChild(targetTd);

        const currentTd = document.createElement("td");
        const controls = document.createElement("div");
        controls.className = "inline-controls";

        const minusBtn = document.createElement("button");
        minusBtn.type = "button";
        minusBtn.className = "btn btn-secondary btn-sm";
        minusBtn.textContent = "−";
        minusBtn.addEventListener("click", () => adjustQty(item.id, -1));

        const valueSpan = document.createElement("span");
        valueSpan.textContent = formatNumber(item.currentQty);

        const plusBtn = document.createElement("button");
        plusBtn.type = "button";
        plusBtn.className = "btn btn-secondary btn-sm";
        plusBtn.textContent = "+";
        plusBtn.addEventListener("click", () => adjustQty(item.id, 1));

        controls.appendChild(minusBtn);
        controls.appendChild(valueSpan);
        controls.appendChild(plusBtn);

        if (item.unit) {
          const unitSpan2 = document.createElement("span");
          unitSpan2.className = "muted";
          unitSpan2.textContent = item.unit;
          controls.appendChild(unitSpan2);
        }

        currentTd.appendChild(controls);
        tr.appendChild(currentTd);

        const neededTd = document.createElement("td");
        const neededSpan = document.createElement("span");
        neededSpan.textContent = formatNumber(needed);
        if (needed > 0) {
          neededSpan.className = "needed-highlight";
        } else {
          neededSpan.className = "muted";
        }
        neededTd.appendChild(neededSpan);
        if (item.unit && needed > 0) {
          const unitSpan3 = document.createElement("span");
          unitSpan3.className = "muted";
          unitSpan3.style.marginLeft = "0.25rem";
          unitSpan3.textContent = item.unit;
          neededTd.appendChild(unitSpan3);
        }
        tr.appendChild(neededTd);

        const actionsTd = document.createElement("td");
        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "btn btn-ghost btn-sm";
        editBtn.textContent = "Bearbeiten";
        editBtn.addEventListener("click", () => startEditItem(item.id));

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "btn btn-danger btn-sm";
        delBtn.textContent = "Löschen";
        delBtn.addEventListener("click", () => deleteItem(item.id));

        actionsTd.appendChild(editBtn);
        actionsTd.appendChild(delBtn);
        tr.appendChild(actionsTd);

        tbody.appendChild(tr);
        visibleCount++;
      }

      if (visibleCount === 0) {
        noDataEl.textContent = "Keine Artikel für diese Filter gefunden.";
        noDataEl.style.display = "block";
      } else {
        noDataEl.style.display = "none";
      }
    }

    function formatNumber(value) {
      const num = typeof value === "number" ? value : parseFloat(value);
      if (isNaN(num)) return "0";
      if (Number.isInteger(num)) return String(num);
      return num.toFixed(2).replace(".", ",");
    }

    function adjustQty(id, delta) {
      const idx = items.findIndex(item => item.id === id);
      if (idx === -1) return;
      const current = items[idx].currentQty || 0;
      const newValue = current + delta;
      items[idx].currentQty = newValue < 0 ? 0 : newValue;
      saveItems();
      renderTable();
    }

    function startEditItem(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;
      editId = id;
      document.getElementById("name").value = item.name || "";
      document.getElementById("category").value = item.category || "";
      document.getElementById("unit").value = item.unit || "";
      document.getElementById("targetQty").value = item.targetQty != null ? String(item.targetQty) : "0";
      document.getElementById("currentQty").value = item.currentQty != null ? String(item.currentQty) : "0";

      document.getElementById("form-title").textContent = "Artikel bearbeiten";
      document.getElementById("form-hint").textContent = "Passe die Werte an und speichere die Änderungen.";
      document.getElementById("submit-btn").textContent = "Änderungen speichern";
      document.getElementById("cancel-edit-btn").style.display = "inline-flex";
    }

    function deleteItem(id) {
      const item = items.find(i => i.id === id);
      const label = item ? ` „${item.name}“` : "";
      if (!confirm("Artikel" + label + " wirklich löschen?")) {
        return;
      }
      items = items.filter(i => i.id !== id);
      saveItems();
      renderTable();
      if (editId === id) {
        resetForm();
      }
    }

    function exportData() {
      const textarea = document.getElementById("backup-text");
      textarea.value = JSON.stringify(items, null, 2);
    }

    function importData() {
      const textarea = document.getElementById("backup-text");
      const text = textarea.value.trim();
      if (!text) {
        alert("Bitte zuerst JSON-Daten in das Textfeld einfügen.");
        return;
      }
      try {
        const parsed = JSON.parse(text);
        if (!Array.isArray(parsed)) {
          alert("Die Daten sehen nicht wie eine Artikelliste aus (erwartet wird ein Array).");
          return;
        }
        if (!confirm("Vorhandene Daten werden überschrieben. Fortfahren?")) {
          return;
        }
        items = parsed;
        saveItems();
        renderTable();
        resetForm();
        alert("Daten erfolgreich übernommen.");
      } catch (e) {
        console.error(e);
        alert("Fehler beim Einlesen der Daten. Sind es gültige JSON-Daten?");
      }
    }

    function clearAllData() {
      if (!confirm("Wirklich alle Daten löschen? Dies kann nicht rückgängig gemacht werden.")) {
        return;
      }
      items = [];
      saveItems();
      renderTable();
      resetForm();
      document.getElementById("backup-text").value = "";
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadItems();
      renderTable();

      document.getElementById("item-form").addEventListener("submit", handleFormSubmit);
      document.getElementById("cancel-edit-btn").addEventListener("click", resetForm);

      document.getElementById("filter-category").addEventListener("change", renderTable);
      document.getElementById("filter-needed-only").addEventListener("change", renderTable);

      document.getElementById("export-btn").addEventListener("click", exportData);
      document.getElementById("import-btn").addEventListener("click", importData);
      document.getElementById("clear-btn").addEventListener("click", clearAllData);
    });
  </script>
</body>
</html>
